<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Red Team Test Case Atlas</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap');

    :root {
      color-scheme: dark;
      --bg: #020611;
      --bg-panel: rgba(10, 20, 40, 0.92);
      --bg-panel-alt: rgba(18, 30, 55, 0.85);
      --border: rgba(255, 255, 255, 0.08);
      --text: #f4f6ff;
      --muted: #8f9bb7;
      --accent: #6ee7ff;
      --accent-2: #ffe66d;
      --danger: #ff6b81;
      --success: #7ed957;
      font-family: 'Space Grotesk', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      background: radial-gradient(circle at top, #0b1e4a 0%, #020611 45%, #01030a 100%);
      color: var(--text);
      padding: 2rem 5px 4rem;
      font-size: 0.95rem;
    }

    .app {
      width: 100%;
      margin: 0 auto;
    }

    header.hero {
      background: linear-gradient(135deg, rgba(23, 35, 74, 0.95), rgba(6, 17, 36, 0.85));
      border: 1px solid var(--border);
      border-radius: 1.2rem;
      padding: clamp(1.5rem, 4vw, 3rem);
      margin-bottom: 1.5rem;
      backdrop-filter: blur(16px);
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
      display: flex;
      flex-direction: column;
      gap: 1.25rem;
    }

    .hero h1 {
      margin: 0;
      font-size: clamp(1.6rem, 3.5vw, 2.6rem);
      font-weight: 600;
    }

    .hero p {
      margin: 0;
      color: var(--muted);
      max-width: 70ch;
      line-height: 1.5;
      font-size: calc(1rem - 2px);
    }

    .hero p.full-width {
      max-width: none;
    }

    .hero p a {
      color: var(--accent);
    }

    .hero p + p {
      margin-top: 1rem;
    }

    .hero-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: center;
    }

    .hero-actions input[type="file"] {
      font-size: 0.95rem;
      color: var(--muted);
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      padding: 0.35rem 0.9rem;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.05);
      font-size: 0.9rem;
      color: var(--muted);
    }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .summary-card {
      background: var(--bg-panel);
      border: 1px solid var(--border);
      border-radius: 1rem;
      padding: 1rem 1.2rem;
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
      position: relative;
      overflow: hidden;
    }

    .summary-card::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(120deg, rgba(110, 231, 255, 0.08), rgba(121, 199, 255, 0));
      opacity: 0;
      transition: opacity 0.3s;
    }

    .summary-card:hover::after {
      opacity: 1;
    }

    .summary-card span.label {
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
    }

    .summary-card strong {
      font-size: 1.4rem;
      font-weight: 600;
    }

    .filters {
      background: var(--bg-panel);
      border: 1px solid var(--border);
      border-radius: 1rem;
      padding: 1rem;
      margin-bottom: 1.5rem;
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: center;
    }

    .filters input[type="search"],
    .filters select {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 0.65rem 1rem;
      color: var(--text);
      font-size: 0.95rem;
      min-width: 220px;
    }

    .filters input::placeholder {
      color: var(--muted);
    }

    .filter-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .filter-chips button {
      border: 1px solid var(--border);
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.04);
      color: var(--text);
      padding: 0.4rem 0.9rem;
      cursor: pointer;
      transition: background 0.2s;
      font-size: 0.9rem;
    }

    .filter-chips button.active {
      background: rgba(110, 231, 255, 0.15);
      border-color: rgba(110, 231, 255, 0.6);
    }

    details.category-panel {
      width: 100%;
      background: rgba(255, 255, 255, 0.02);
      border: 1px solid var(--border);
      border-radius: 0.75rem;
      padding: 0.75rem 1rem;
    }

    details.category-panel summary {
      cursor: pointer;
      font-weight: 600;
      outline: none;
    }

    .category-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 0.5rem;
      margin-top: 0.75rem;
    }

    .category-grid label {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      font-size: 0.9rem;
      padding: 0.4rem 0.6rem;
      border-radius: 0.5rem;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .status-banner {
      padding: 0.6rem 1rem;
      border-radius: 0.8rem;
      font-size: 0.9rem;
      margin-bottom: 1rem;
      border: 1px solid transparent;
      transition: background 0.3s, color 0.3s;
    }

    .status-banner.loading {
      background: rgba(110, 231, 255, 0.08);
      border-color: rgba(110, 231, 255, 0.4);
    }

    .status-banner.error {
      background: rgba(255, 107, 129, 0.12);
      border-color: rgba(255, 107, 129, 0.5);
    }

    .status-banner.success {
      background: rgba(126, 217, 87, 0.12);
      border-color: rgba(126, 217, 87, 0.5);
    }

    .table-wrapper {
      background: var(--bg-panel-alt);
      border: 1px solid var(--border);
      border-radius: 1rem;
      overflow: hidden;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }

    thead {
      background: rgba(255, 255, 255, 0.02);
    }

    th,
    td {
      padding: 1rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.04);
      vertical-align: top;
      text-align: left;
    }

    th {
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-size: 0.72rem;
      color: var(--muted);
      cursor: pointer;
      user-select: none;
      position: relative;
    }

    th.sortable::after {
      content: '';
      position: absolute;
      right: 0.4rem;
      top: 50%;
      width: 0;
      height: 0;
      border-left: 5px solid transparent;
      border-right: 5px solid transparent;
      border-top: 6px solid var(--muted);
      transform: translateY(-50%);
      opacity: 0.4;
    }

    th.sortable.asc::after {
      border-top: none;
      border-bottom: 6px solid var(--accent);
      opacity: 1;
    }

    th.sortable.desc::after {
      border-top: 6px solid var(--accent);
      opacity: 1;
    }

    tbody tr:hover {
      background: rgba(255, 255, 255, 0.02);
    }

    .category-badge {
      display: inline-flex;
      border-radius: 999px;
      padding: 0.2rem 0.6rem;
      font-size: 0.75rem;
      letter-spacing: 0.04em;
      border: 1px solid rgba(255, 255, 255, 0.15);
      color: var(--accent);
      text-transform: uppercase;
    }

    .mitre-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
    }

    .mitre-badge {
      display: inline-flex;
      align-items: center;
      border-radius: 0.4rem;
      padding: 0.2rem 0.45rem;
      font-size: 0.78rem;
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.08);
      text-decoration: none;
      color: inherit;
      line-height: 1;
    }

    .mitre-badge.attack {
      color: var(--accent-2);
      border-color: rgba(255, 230, 109, 0.5);
    }

    .testcase-text {
      line-height: 1.4;
    }

    .copy-btn {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 0.6rem;
      color: var(--muted);
      padding: 0.3rem 0.75rem;
      font-size: 0.8rem;
      cursor: pointer;
      transition: border 0.2s, color 0.2s;
      margin-top: 0.35rem;
    }

    .copy-btn:hover {
      border-color: var(--accent);
      color: var(--text);
    }

    .analytics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 1rem;
      margin: 1.5rem 0;
    }

    .analytics-card {
      background: var(--bg-panel);
      border: 1px solid var(--border);
      border-radius: 1rem;
      padding: 1.2rem;
    }

    .analytics-card h3 {
      margin: 0 0 0.6rem 0;
      font-size: 1.05rem;
    }

    .muted {
      color: var(--muted);
    }

    .progress-row {
      margin: 0.5rem 0;
    }

    .progress-track {
      height: 6px;
      background: rgba(255, 255, 255, 0.08);
      border-radius: 999px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      border-radius: inherit;
      background: linear-gradient(90deg, var(--accent), var(--accent-2));
    }

    .empty-state {
      text-align: center;
      padding: 2rem;
      color: var(--muted);
    }

    mark {
      background: rgba(255, 230, 109, 0.35);
      color: inherit;
      padding: 0.05rem 0.2rem;
      border-radius: 0.3rem;
    }

    @media (max-width: 640px) {
      body {
        padding: 1rem;
      }

      th,
      td {
        padding: 0.75rem;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="hero">
      <div>
        <h1>Red Team Test Case Atlas</h1>
        <p class="full-width">
          Dive into the world’s largest library of red-teaming test cases, curated from real adversarial operations and rebuilt locally via the `scripts/build_dashboard.mjs` pipeline. Regenerate this static snapshot whenever the CSV changes, then ship the intel anywhere without relying on external services.
        </p>
        <p class="full-width">
          Each test case originates from a deep analysis of every Darknet Diaries episode, reframed through a breach-and-attack simulation lens so you can replay the exact tradecraft adversaries have used in the wild. The mapping from raw narratives to structured cases is largely automated, and manual review happens only when time permits.
        </p>
        <p class="full-width">
          Disclaimer: this dataset is for lawful, defensive security research only. Because the content is machine-generated from public stories, it may include inaccuracies, deprecated techniques, or references to real individuals, companies, governments, or countries. Nothing here should be treated as an endorsement, accusation, or instruction to target any entity; you are solely responsible for vetting every scenario, redacting sensitive details, obtaining proper authorization, and ensuring compliance with all applicable laws and policies before use.
        </p>
        <p class="full-width">
          Review the primary legal notice at <a href="https://chintangurjar.com/disclaimer/" target="_blank" rel="noopener noreferrer">chintangurjar.com/disclaimer</a> for the complete disclaimer that governs this project.
        </p>
      </div>
      <div class="hero-actions">
        <span class="chip" id="sourceChip">Source: static dataset</span>
        <span class="chip" id="activeFiltersChip">Active filters: 0</span>
      </div>
    </header>

    <div id="statusBanner" class="status-banner loading">Preparing dashboard…</div>

    <section class="summary-grid" id="summaryGrid"></section>

    <section class="analytics">
      <article class="analytics-card">
        <h3>Top 10 Categories</h3>
        <div id="categoryBreakdown"></div>
      </article>
      <article class="analytics-card">
        <h3>MITRE Coverage</h3>
        <div id="mitreAnalytics"></div>
      </article>
      <article class="analytics-card">
        <h3>Filter Insights</h3>
        <div id="filterInsights"></div>
      </article>
    </section>

    <section class="filters">
      <input id="searchInput" type="search" placeholder="Search test cases, categories, MITRE IDs…" />
      <select id="mitreFilter">
        <option value="all">All MITRE states</option>
        <option value="attack">Has ATT&CK IDs</option>
        <option value="without">No MITRE tags</option>
      </select>
      <div class="filter-chips">
        <button id="clearFiltersBtn" type="button">Clear filters</button>
        <button id="resetSortBtn" type="button">Reset sort</button>
      </div>
      <details class="category-panel">
        <summary>Filter by category</summary>
        <div id="categoryFilters" class="category-grid"></div>
      </details>
    </section>

    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th class="sortable" data-key="category">Category</th>
            <th>Test Case</th>
            <th class="sortable" data-key="attackCount">MITRE ATT&CK</th>
          </tr>
        </thead>
        <tbody id="casesBody">
          <tr><td colspan="3" class="empty-state">Loading data…</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    window.__TEST_CASES__ = [{"episode_id":0,"category":"Initial Access","test_case":"Apply for a job at single company using various personas and qualifications to exploit biases in hiring processes.","mitre_attack_ids":["T1031","T1043"]},{"episode_id":0,"category":"Covert Movement","test_case":"Obtain a private pilot's license using a career development loan to create a valid means of transportation for covert movement.","mitre_attack_ids":["T1048"]},{"episode_id":0,"category":"Initial Access","test_case":"Pose as a a country's ambassador to gain access to a building by presenting a fake identity and pretext.","mitre_attack_ids":["T1553.002"]},{"episode_id":0,"category":"Social Engineering","test_case":"Use persuasion tactics, such as friendliness and assertiveness, to convince a receptionist to grant access to the building. Use a convincing alias and backstory to gain trust with reception staff.","mitre_attack_ids":["T1091.001"]},{"episode_id":0,"category":"Social Engineering","test_case":"Pretend to be an expert in the target industry or country of origin to avoid suspicion.","mitre_attack_ids":[]},{"episode_id":0,"category":"Insider Actions","test_case":"Infiltrate the organization by posing as an employee or contractor and gaining access to secure areas.","mitre_attack_ids":["T1177"]},{"episode_id":0,"category":"Social Engineering","test_case":"Spoof IP address to mimic an external threat actor (e.g., Russian IP) and observe response.","mitre_attack_ids":["T1208"]},{"episode_id":0,"category":"Initial Access","test_case":"Walk around the perimeter of a facility to identify vulnerabilities in physical security measures, such as old or weak fencing.","mitre_attack_ids":["T1590"]},{"episode_id":0,"category":"Initial Access","test_case":"Drive to the facility at night, parking in a location with shadows.","mitre_attack_ids":["T1020"]},{"episode_id":0,"category":"Command and Control","test_case":"Connect to unlocked terminals and take photos as proof of access.","mitre_attack_ids":["T1074.001"]},{"episode_id":0,"category":"Lateral Movement","test_case":"Search for alternative exit points, such as loading doors not attached to alarms.","mitre_attack_ids":[]},{"episode_id":0,"category":"Initial Access","test_case":"Conduct a reconnaissance of the facility's parking lots to identify vehicles with accessible keys.","mitre_attack_ids":["T1040"]},{"episode_id":0,"category":"Insider Actions","test_case":"Simulate a scenario where an insider provides unauthorized access to vehicles with easily accessible keys.","mitre_attack_ids":["T1098.002"]},{"episode_id":0,"category":"Social Engineering","test_case":"Pose as a maintenance personnel and request access to perform 'maintenance on immersion cooling for the fluid'.","mitre_attack_ids":["T1208.005","TA0001"]},{"episode_id":0,"category":"Command and Control","test_case":"Assess if an actor with physical access to the data center can use their knowledge of internal systems to gain unauthorized access.","mitre_attack_ids":["T1071","TA0010"]},{"episode_id":0,"category":"Initial Access","test_case":"Spoof phone calls to an organization's maintenance team, mimicking a legitimate issue.","mitre_attack_ids":["T1118"]},{"episode_id":0,"category":"Command and Control","test_case":"Use existing subsea cables for internet signals as a means of establishing command and control communication with an implanted device.","mitre_attack_ids":[]},{"episode_id":0,"category":"Initial Access","test_case":"Deploy underwater subsea servers without on-site physical access, using Wet-Mate cables and dielectric fluid-filled containers.","mitre_attack_ids":["T1078.003","T1195"]},{"episode_id":0,"category":"Covert Movement","test_case":"Use a remotely operated vehicle (ROV) to retrieve and repair servers without physical on-site presence.","mitre_attack_ids":["T1053","T1204"]},{"episode_id":0,"category":"Physical Intrusion","test_case":"Simulate physical intrusion using an ROV, vessel, divers, or a submarine to access and compromise the underwater servers.","mitre_attack_ids":["T1090","T1102"]},{"episode_id":0,"category":"Command-and-Control","test_case":"Establish communication channels through satellite connections or other external networks to maintain command and control.","mitre_attack_ids":["T1043","T1091"]},{"episode_id":0,"category":"Insider Actions","test_case":"Conduct a search within the organization's portal to gather information on security policies without explicit authorization.","mitre_attack_ids":["TA0011"]}];
  </script>
  <script>
    const state = {
      cases: [],
      filtered: [],
      categories: [],
    };

    const filters = {
      search: '',
      categories: new Set(),
      mitre: 'all',
      sortKey: 'category',
      sortDir: 'asc',
    };

    const ui = {
      banner: document.getElementById('statusBanner'),
      summaryGrid: document.getElementById('summaryGrid'),
      categoryBreakdown: document.getElementById('categoryBreakdown'),
      mitreAnalytics: document.getElementById('mitreAnalytics'),
      filterInsights: document.getElementById('filterInsights'),
      categoryFilters: document.getElementById('categoryFilters'),
      searchInput: document.getElementById('searchInput'),
      mitreFilter: document.getElementById('mitreFilter'),
      casesBody: document.getElementById('casesBody'),
      activeFiltersChip: document.getElementById('activeFiltersChip'),
      sourceChip: document.getElementById('sourceChip'),
    };

    const ESCAPE_MAP = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;' };
    const ATTR_ESCAPE_MAP = { ...ESCAPE_MAP, "'": '&#39;' };

    const htmlEscape = (text = '') => String(text).replace(/[&<>"]/g, (char) => ESCAPE_MAP[char] || char);
    const attrEscape = (text = '') => String(text).replace(/[&<>"']/g, (char) => ATTR_ESCAPE_MAP[char] || char);

    function splitMitreString(raw = '') {
      if (Array.isArray(raw)) return raw;
      if (typeof raw !== 'string') return [];
      return raw
        .split(/\s*,\s*/)
        .map((token) => token.trim())
        .filter(Boolean);
    }

    function normalizeMitreList(input) {
      if (!input && input !== 0) return [];
      const entries = Array.isArray(input) ? input : splitMitreString(input);
      return entries
        .map((entry) => parseMitreEntry(entry))
        .filter(Boolean);
    }

    function parseMitreEntry(entry) {
      if (!entry && entry !== 0) return null;
      if (typeof entry === 'object') {
        const label = (entry.label || entry.title || entry.id || '').trim();
        const id = (entry.id || extractMitreId(label)).trim();
        const url = (entry.url || entry.href || '').trim();
        if (!label && !id) return null;
        return { id: id || label, label: label || id, url };
      }
      const text = String(entry).trim();
      if (!text) return null;
      const match = text.match(/\((https?:\/\/[^)]+)\)\s*$/);
      const url = match ? match[1] : '';
      const label = match ? text.replace(/\((https?:\/\/[^)]+)\)\s*$/, '').trim() : text;
      const id = extractMitreId(label);
      return { id: id || label, label: label || id, url };
    }

    function extractMitreId(label = '') {
      const match = label.trim().match(/^([A-Z0-9.-]+)/);
      return match ? match[1] : label.trim();
    }

    function mitreListToText(list) {
      return list
        .map((ref) => `${ref.id || ''} ${ref.label || ''}`.trim())
        .filter(Boolean)
        .join(' ');
    }

    document.addEventListener('DOMContentLoaded', () => {
      const seededCases = Array.isArray(window.__TEST_CASES__) ? window.__TEST_CASES__ : [];
      if (seededCases.length) {
        setCasesFromObjects(seededCases);
        setBanner(`Loaded ${seededCases.length} embedded test cases`, 'success');
        ui.sourceChip.textContent = 'Source: static dataset';
      } else {
        setCasesFromObjects([]);
        setBanner('No embedded test cases. Rebuild with data.', 'error');
        ui.sourceChip.textContent = 'Source: static dataset (empty)';
      }
      ui.searchInput.addEventListener('input', (e) => {
        filters.search = e.target.value.trim();
        applyFilters();
      });
      ui.mitreFilter.addEventListener('change', (e) => {
        filters.mitre = e.target.value;
        applyFilters();
      });
      document.getElementById('clearFiltersBtn').addEventListener('click', () => {
        filters.search = '';
        filters.categories.clear();
        filters.mitre = 'all';
        ui.searchInput.value = '';
        ui.mitreFilter.value = 'all';
        updateCategorySelections();
        applyFilters();
      });
      document.getElementById('resetSortBtn').addEventListener('click', () => {
        filters.sortKey = 'episode_id';
        filters.sortDir = 'asc';
        refreshSortIndicators();
        applyFilters();
      });
      document.querySelectorAll('th.sortable').forEach((th) => {
        th.addEventListener('click', () => {
          const key = th.dataset.key;
          if (filters.sortKey === key) {
            filters.sortDir = filters.sortDir === 'asc' ? 'desc' : 'asc';
          } else {
            filters.sortKey = key;
            filters.sortDir = 'asc';
          }
          refreshSortIndicators();
          applyFilters();
        });
      });
    });

    function setCasesFromObjects(objects = []) {
      state.cases = objects.map((item) => ({
        episode_id: Number(item.episode_id) || 0,
        category: item.category || 'Uncategorized',
        test_case: item.test_case || '',
        mitre_attack_ids: normalizeMitreList(item.mitre_attack_ids),
      }));
      state.categories = Array.from(new Set(state.cases.map((c) => c.category))).sort();
      renderCategoryFilters();
      applyFilters();
    }

    function applyFilters() {
      const query = filters.search.toLowerCase();
      state.filtered = state.cases.filter((item) => {
        if (filters.categories.size && !filters.categories.has(item.category)) return false;
        if (query) {
          const haystack = [
            String(item.episode_id),
            item.category,
            item.test_case,
            mitreListToText(item.mitre_attack_ids),
          ]
            .join(' ')
            .toLowerCase();
          if (!haystack.includes(query)) return false;
        }
        const hasAttack = item.mitre_attack_ids.length > 0;
        switch (filters.mitre) {
          case 'attack':
            if (!hasAttack) return false;
            break;
          case 'without':
            if (hasAttack) return false;
            break;
          default:
            break;
        }
        return true;
      });

      state.filtered.sort((a, b) => compareByKey(a, b, filters.sortKey, filters.sortDir));
      renderTable();
      renderSummary();
      renderCategoryBreakdown();
      renderMitreAnalytics();
      renderFilterInsights();
      updateActiveFiltersCount();
    }

    function compareByKey(a, b, key, dir) {
      const modifier = dir === 'asc' ? 1 : -1;
      if (key === 'episode_id') {
        return (a.episode_id - b.episode_id) * modifier;
      }
      if (key === 'attackCount') {
        return (a.mitre_attack_ids.length - b.mitre_attack_ids.length) * modifier;
      }
      const valueA = (a[key] || '').toString().toLowerCase();
      const valueB = (b[key] || '').toString().toLowerCase();
      if (valueA < valueB) return -1 * modifier;
      if (valueA > valueB) return 1 * modifier;
      return 0;
    }

    function renderTable() {
      if (!state.filtered.length) {
        ui.casesBody.innerHTML = `<tr><td colspan="3" class="empty-state">No test cases match your filters.</td></tr>`;
        return;
      }
      const query = filters.search;
      const highlight = (text) => {
        if (!query) return htmlEscape(text);
        const safeQuery = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        return htmlEscape(text).replace(new RegExp(`(${safeQuery})`, 'gi'), '<mark>$1</mark>');
      };
      ui.casesBody.innerHTML = state.filtered
        .map((item) => `
          <tr>
            <td><span class="category-badge">${htmlEscape(item.category)}</span></td>
            <td>
              <p class="testcase-text">${highlight(item.test_case)}</p>
              <button class="copy-btn" data-copy="${attrEscape(item.test_case)}">Copy test case</button>
            </td>
            <td>${renderMitreBadges(item.mitre_attack_ids, 'attack')}</td>
          </tr>
        `)
        .join('');
      ui.casesBody.querySelectorAll('.copy-btn').forEach((btn) => {
        btn.addEventListener('click', () => {
          navigator.clipboard.writeText(btn.dataset.copy);
          btn.textContent = 'Copied!';
          setTimeout(() => {
            btn.textContent = 'Copy test case';
          }, 1200);
        });
      });
    }

    function renderMitreBadges(list, type) {
      if (!list.length) {
        return `<span class="muted">—</span>`;
      }
      return `<div class="mitre-badges">
        ${list
          .map((ref) => {
            const label = ref?.label || ref?.id || '';
            if (!label) return '';
            const safeLabel = htmlEscape(label);
            const title = ref?.id && ref?.label && !ref.label.startsWith(ref.id)
              ? `${ref.id} · ${ref.label}`
              : label;
            if (ref?.url) {
              return `<a class="mitre-badge ${type}" href="${attrEscape(ref.url)}" target="_blank" rel="noopener noreferrer" title="${attrEscape(title)}">${safeLabel}</a>`;
            }
            return `<span class="mitre-badge ${type}" title="${attrEscape(title)}">${safeLabel}</span>`;
          })
          .join('')}
      </div>`;
    }

    function renderSummary() {
      const totalCases = state.filtered.length;
      const totalCategories = new Set(state.filtered.map((c) => c.category)).size;
      const attackRefs = state.filtered.reduce((sum, c) => sum + c.mitre_attack_ids.length, 0);
      const topCategory = getTopCategory();
      ui.summaryGrid.innerHTML = [
        { label: 'Test cases', value: totalCases.toLocaleString() },
        { label: 'Categories', value: totalCategories.toLocaleString() },
        { label: 'MITRE refs', value: `${attackRefs} ATT&CK tags` },
        { label: 'Top category', value: topCategory?.name ?? '—', hint: topCategory ? `${topCategory.count} cases` : '' },
      ]
        .map((card) => `
          <article class="summary-card">
            <span class="label">${card.label}</span>
            <strong>${card.value}</strong>
            ${card.hint ? `<small style="color: var(--muted);">${card.hint}</small>` : ''}
          </article>
        `)
        .join('');
    }

    function getTopCategory() {
      if (!state.filtered.length) return null;
      const counts = state.filtered.reduce((map, item) => {
        map[item.category] = (map[item.category] || 0) + 1;
        return map;
      }, {});
      const [name, count] = Object.entries(counts).sort((a, b) => b[1] - a[1])[0];
      return { name, count };
    }

    function renderCategoryFilters() {
      if (!state.categories.length) {
        ui.categoryFilters.innerHTML = '<p class="muted">No categories loaded.</p>';
        return;
      }
      ui.categoryFilters.innerHTML = state.categories
        .map((category) => `
          <label>
            <input type="checkbox" value="${category}" />
            <span>${category}</span>
          </label>
        `)
        .join('');
      ui.categoryFilters.querySelectorAll('input[type="checkbox"]').forEach((checkbox) => {
        checkbox.addEventListener('change', (event) => {
          const { value, checked } = event.target;
          if (checked) {
            filters.categories.add(value);
          } else {
            filters.categories.delete(value);
          }
          applyFilters();
        });
      });
      updateCategorySelections();
    }

    function updateCategorySelections() {
      const checkboxes = ui.categoryFilters.querySelectorAll('input[type="checkbox"]');
      if (!checkboxes.length) return;
      checkboxes.forEach((checkbox) => {
        checkbox.checked = filters.categories.has(checkbox.value);
      });
    }

    function renderCategoryBreakdown() {
      if (!state.filtered.length) {
        ui.categoryBreakdown.innerHTML = '<p class="muted">No data.</p>';
        return;
      }
      const counts = state.filtered.reduce((acc, item) => {
        acc[item.category] = (acc[item.category] || 0) + 1;
        return acc;
      }, {});
      const total = state.filtered.length;
      ui.categoryBreakdown.innerHTML = Object.entries(counts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10)
        .map(([category, count]) => {
          const percent = Math.round((count / total) * 100);
          return `
            <div class="progress-row">
              <div style="display:flex;justify-content:space-between;font-size:0.9rem;">
                <span>${category}</span>
                <span>${count} • ${percent}%</span>
              </div>
              <div class="progress-track">
                <div class="progress-fill" style="width:${percent}%;"></div>
              </div>
            </div>
          `;
        })
        .join('');
    }

    function renderMitreAnalytics() {
      const totalAttack = state.filtered.reduce((sum, c) => sum + c.mitre_attack_ids.length, 0);
      const withMitre = state.filtered.filter((c) => c.mitre_attack_ids.length).length;
      const withoutMitre = state.filtered.length - withMitre;
      const attackRate = state.filtered.length ? Math.round((withMitre / state.filtered.length) * 100) : 0;
      ui.mitreAnalytics.innerHTML = `
        <p>Total ATT&CK refs: <strong>${totalAttack}</strong></p>
        <p>Cases with ATT&CK coverage: <strong>${withMitre}</strong></p>
        <div class="progress-track" style="margin:0.5rem 0;">
          <div class="progress-fill" style="width:${attackRate}%;"></div>
        </div>
        <p style="font-size:0.9rem;color:var(--muted);">${attackRate}% with coverage · ${withoutMitre} without</p>
      `;
    }

    function renderFilterInsights() {
      const parts = [];
      if (filters.search) parts.push(`Searching for "<strong>${filters.search}</strong>"`);
      if (filters.categories.size) parts.push(`Categories: <strong>${Array.from(filters.categories).join(', ')}</strong>`);
      const mitreLabel = {
        all: 'any MITRE state',
        attack: 'cases with ATT&CK IDs',
        without: 'cases without ATT&CK IDs',
      }[filters.mitre];
      parts.push(`MITRE filter: <strong>${mitreLabel}</strong>`);
      ui.filterInsights.innerHTML = parts.length
        ? `<p>${parts.join(' · ')}</p>`
        : '<p class="muted">No filters applied.</p>';
    }

    function updateActiveFiltersCount() {
      let count = 0;
      if (filters.search) count += 1;
      if (filters.categories.size) count += filters.categories.size;
      if (filters.mitre !== 'all') count += 1;
      ui.activeFiltersChip.textContent = `Active filters: ${count}`;
    }

    function setBanner(message, stateClass) {
      ui.banner.textContent = message;
      ui.banner.className = `status-banner ${stateClass}`;
    }

    function refreshSortIndicators() {
      document.querySelectorAll('th.sortable').forEach((th) => {
        th.classList.remove('asc', 'desc');
        if (th.dataset.key === filters.sortKey) {
          th.classList.add(filters.sortDir);
        }
      });
    }
  </script>
</body>
</html>
